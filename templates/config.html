<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurações do Sistema</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
        }

        .container {
            width: 90%;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #ffffff; 
            border-bottom: 2px solid #005a87;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        h2 {
            color: #00407a;
            border-bottom: 2px solid #005a87;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .config-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background-color: #fdfdfd;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        input[type="time"],
        input[type="number"],
        input[type="text"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .checkbox-group label {
            font-weight: normal;
            display: inline-block;
            margin-right: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }

        button[type="submit"] {
            background-color: #005a87;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }

        button[type="submit"]:hover {
            background-color: #00407a;
        }

        .flash-message {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            color: #fff;
        }

        .flash-success {
            background-color: #28a745;
        }

        .flash-error {
            background-color: #dc3545;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #00407a;
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .btn-delete-user {
            background-color: #dc3545;
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        .btn-delete-user:hover {
            background-color: #c82333;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-row>div {
            flex: 1;
        }

        .form-row label,
        .form-row input,
        .form-row select {
            margin-bottom: 0;
        }

        .availability-options {
            margin-top: 10px;
        }

        .availability-options div {
            margin-bottom: 10px;
        }

        #specific_dates_config {
            display: none;
        }

        #weekdays_config {
            display: block;
        }

        .form-delete-action {
            background-color: transparent !important;
            padding: 0 !important;
            margin: 0 !important;
            box-shadow: none !important;
            border-radius: 0 !important;
            width: auto !important;
            max-width: none !important;
            text-align: center !important;
            display: inline-block;
        }

        .form-delete-action .btn-delete-user {
            margin: 0;
        }

        .current-settings-summary {
            background-color: #e9f5ff;
            border: 1px solid #b3d7ff;
            border-radius: 5px;
            padding: 15px 20px;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .current-settings-summary h3 {
            color: #00407a;
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: 1px solid #b3d7ff;
            padding-bottom: 8px;
        }

        .current-settings-summary p {
            margin: 5px 0;
            color: #333;
        }

        .current-settings-summary strong {
            color: #005a87;
        }
    </style>
</head>

<body>
    <header>
        <div class="logo">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo">
        </div>
        <h1>Configurações do Sistema</h1>
        <nav style="position: absolute; right: 20px;">
            <a href="{{ url_for('admin') }}"
                style="color: white; text-decoration: none; padding: 10px; background-color: #007bff; border-radius: 5px;">Voltar
                ao Painel</a>
        </nav>
    </header>

    <div class="container"> {% if flash_message %}
        <div class="flash-message flash-success">{{ flash_message }}</div>
        {% endif %}
        {% if flash_error_message %}
        <div class="flash-message flash-error">{{ flash_error_message }}</div>
        {% endif %}

        <section class="current-settings-summary">
            <h3>Resumo das Configurações Atuais</h3>

            <p><strong>Horário de Atendimento:</strong> {{ settings.start_time }} - {{ settings.end_time }}</p>
            <p><strong>Horário de Almoço:</strong> {{ settings.lunch_start_time }} - {{ settings.lunch_end_time }}
            </p>

            {% set duration_label = settings.appointment_duration ~ " minutos" %}
            {% for option in duration_options %}
            {% if option.value == settings.appointment_duration %}
            {% set duration_label = option.label %}
            {% endif %}
            {% endfor %}
            <p><strong>Duração da Consulta:</strong> {{ duration_label }}</p>

            {% if settings.max_appointments_per_user > 0 %}
            <p><strong>Limite por Utilizador:</strong> {{ settings.max_appointments_per_user }} consulta(s) a cada
                {{ settings.appointments_period_days }} dia(s)</p>
            {% else %}
            <p><strong>Limite por Utilizador:</strong> Ilimitado</p>
            {% endif %}

            <p><strong>Modo de Disponibilidade:</strong>
                {% if settings.availability_mode == 'weekdays' %}
                Dias da Semana
                {% elif settings.availability_mode == 'specific_dates' %}
                Datas Específicas
                {% else %}
                {{ settings.availability_mode }}
                {% endif %}
            </p>

            {% if settings.availability_mode == 'weekdays' %}
            {% set weekday_map = {"0": "Seg", "1": "Ter", "2": "Qua", "3": "Qui", "4": "Sex", "5": "Sáb", "6":
            "Dom"} %}
            {% set display_weekdays = [] %}
            {% if settings.available_weekdays %} {# Garante que não está vazio #}
            {% for day_num_str in settings.available_weekdays.split(',') %}
            {% set day_num = day_num_str | trim %} {# Remove espaços em branco #}
            {% if day_num in weekday_map %}
            {% set _ = display_weekdays.append(weekday_map[day_num]) %}
            {% endif %}
            {% endfor %}
            {% endif %}
            <p><strong>Dias Configurados:</strong> {{ display_weekdays | join(', ') if display_weekdays else "Nenhum
                dia da semana configurado" }}</p>
            {% elif settings.availability_mode == 'specific_dates' %}
            <p><strong>Datas Configuradas:</strong> {{ settings.specific_available_dates if
                settings.specific_available_dates else "Nenhuma data específica configurada" }}</p>
            {% endif %}
        </section>
        
        <section class="config-section">
            <h2>Horários e Duração</h2>
            <form method="POST" action="{{ url_for('config_page') }}">
                <input type="hidden" name="form_name" value="general_settings">
                <div class="form-row">
                    <div>
                        <label for="start_time">Horário de Início do Atendimento:</label>
                        <input type="time" id="start_time" name="start_time" value="{{ settings.start_time }}"
                            required>
                    </div>
                    <div>
                        <label for="end_time">Horário de Fim do Atendimento:</label>
                        <input type="time" id="end_time" name="end_time" value="{{ settings.end_time }}" required>
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="lunch_start_time">Início do Almoço:</label>
                        <input type="time" id="lunch_start_time" name="lunch_start_time"
                            value="{{ settings.lunch_start_time }}" required>
                    </div>
                    <div>
                        <label for="lunch_end_time">Fim do Almoço:</label>
                        <input type="time" id="lunch_end_time" name="lunch_end_time"
                            value="{{ settings.lunch_end_time }}" required>
                    </div>
                </div>
                <div>
                    <label for="appointment_duration">Duração da Consulta (minutos):</label>
                    <select id="appointment_duration" name="appointment_duration" required>
                        {% for option in duration_options %}
                        <option value="{{ option.value }}" {% if option.value==settings.appointment_duration
                            %}selected{% endif %}>
                            {{ option.label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit">Salvar Horários</button>
            </form>
        </section>

        <section class="config-section">
            <h2>Disponibilidade de Agendamento</h2>
            <form method="POST" action="{{ url_for('config_page') }}">
                <input type="hidden" name="form_name" value="availability_settings">
                <label for="availability_mode">Modo de Disponibilidade:</label>
                <select id="availability_mode" name="availability_mode">
                    <option value="weekdays" {% if settings.availability_mode=='weekdays' %}selected{% endif %}>Dias
                        da Semana</option>
                    <option value="specific_dates" {% if settings.availability_mode=='specific_dates' %}selected{%
                        endif %}>Datas Específicas</option>
                </select>

                <div id="weekdays_config" class="availability-options">
                    <label>Dias da Semana Disponíveis:</label>
                    <div class="checkbox-group">
                        {% set current_weekdays = [] %}
                        {% if settings.available_weekdays %}
                        {% set current_weekdays = settings.available_weekdays.split(',') | map('trim') | list %}
                        {% endif %}
                        <label><input type="checkbox" name="available_weekdays" value="0" {% if "0" in
                                current_weekdays %}checked{% endif %}> Segunda</label>
                        <label><input type="checkbox" name="available_weekdays" value="1" {% if "1" in
                                current_weekdays %}checked{% endif %}> Terça</label>
                        <label><input type="checkbox" name="available_weekdays" value="2" {% if "2" in
                                current_weekdays %}checked{% endif %}> Quarta</label>
                        <label><input type="checkbox" name="available_weekdays" value="3" {% if "3" in
                                current_weekdays %}checked{% endif %}> Quinta</label>
                        <label><input type="checkbox" name="available_weekdays" value="4" {% if "4" in
                                current_weekdays %}checked{% endif %}> Sexta</label>
                        <label><input type="checkbox" name="available_weekdays" value="5" {% if "5" in
                                current_weekdays %}checked{% endif %}> Sábado</label>
                        <label><input type="checkbox" name="available_weekdays" value="6" {% if "6" in
                                current_weekdays %}checked{% endif %}> Domingo</label>
                    </div>
                </div>

                <div id="specific_dates_config" class="availability-options">
                    <label for="specific_available_dates">Datas Específicas Disponíveis (YYYY-MM-DD, separadas por
                        vírgula):</label>
                    <textarea id="specific_available_dates" name="specific_available_dates"
                        placeholder="Ex: 2024-12-25,2025-01-01">{{ settings.specific_available_dates }}</textarea>
                </div>
                <button type="submit">Salvar Disponibilidade</button>
            </form>
        </section>

        <section class="config-section">
            <h2>Limite de Consultas por Usuário</h2>
            <form method="POST" action="{{ url_for('config_page') }}">
                <input type="hidden" name="form_name" value="user_limit_settings">
                <div class="form-row">
                    <div>
                        <label for="max_appointments_per_user">Número Máximo de Consultas:</label>
                        <input type="number" id="max_appointments_per_user" name="max_appointments_per_user"
                            value="{{ settings.max_appointments_per_user }}" min="0" required>
                        <small>(0 para ilimitado)</small>
                    </div>
                    <div>
                        <label for="appointments_period_days">Dentro de um Período de (dias):</label>
                        <input type="number" id="appointments_period_days" name="appointments_period_days"
                            value="{{ settings.appointments_period_days }}" min="0" required>
                        <small>(Ex: 7 para semanal, 30 para mensal. Se consultas for 0, este campo é
                            ignorado)</small>
                    </div>
                </div>
                <button type="submit">Salvar Limites</button>
            </form>
        </section>

        <section class="config-section">
            <h2>Criar Conta de Administrador Secundário</h2>
            <form method="POST" action="{{ url_for('config_page') }}">
                <input type="hidden" name="form_name" value="create_admin_user">
                <label for="new_admin_username">Nome de Usuário:</label>
                <input type="text" id="new_admin_username" name="new_admin_username" required>

                <label for="new_admin_password">Senha:</label>
                <input type="password" id="new_admin_password" name="new_admin_password" required>

                <label for="new_admin_confirm_password">Confirmar Senha:</label>
                <input type="password" id="new_admin_confirm_password" name="new_admin_confirm_password" required>
                <button type="submit">Criar Conta</button>
            </form>
        </section>

        <section class="config-section">
            <h2>Gerenciar Contas de Administradores Secundários</h2>
            {% if secondary_users %}
            <table>
                <thead>
                    <tr>
                        <th>Nome de Usuário</th>
                        <th>Criado em</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in secondary_users %}
                    <tr>
                        <td>{{ user.username }}</td>
                        <td>{{ user.created_at.split('T')[0] }}</td>
                        <td>
                            <form method="POST" action="{{ url_for('delete_secondary_user_route', user_id=user.id) }}"
                                onsubmit="return confirm('Tem certeza que deseja apagar este administrador?');"
                                class="form-delete-action">
                                <button type="submit" class="btn-delete-user">Apagar</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>Nenhuma conta de administrador secundário encontrada.</p>
            {% endif %}
        </section>
        
    </div> <script>
        document.addEventListener('DOMContentLoaded', function () {
            const availabilityModeSelect = document.getElementById('availability_mode');
            const weekdaysConfigDiv = document.getElementById('weekdays_config');
            const specificDatesConfigDiv = document.getElementById('specific_dates_config');

            function toggleAvailabilityOptions() {
                if (availabilityModeSelect.value === 'weekdays') {
                    weekdaysConfigDiv.style.display = 'block';
                    specificDatesConfigDiv.style.display = 'none';
                } else {
                    weekdaysConfigDiv.style.display = 'none';
                    specificDatesConfigDiv.style.display = 'block';
                }
            }

            toggleAvailabilityOptions();

            availabilityModeSelect.addEventListener('change', toggleAvailabilityOptions);
        });
    </script>
</body>

</html>